<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Прохождение теста</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Тест по Базам Данных</h1>
        <form id="questionForm">
            {% for q in questions %}
                <div class="question-block">
                    <h3>{{ loop.index }}. {{ q['question'] }}</h3>
                    <ul class="options-list">
                        {% for option in q['shuffled_options'] %}
                            <li>
                                <input type="radio" name="option{{ loop.index0 }}" id="q{{ loop.index0 }}_opt{{ loop.index }}" value="{{ loop.index0 }}" required>
                                <label for="q{{ loop.index0 }}_opt{{ loop.index }}">{{ option }}</label>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
            <button type="submit">Завершить тест</button>
        </form>
    </div>

    <script>
        // Переменная 'questions' уже объявлена в HTML через Jinja2: var questions = {{ questions | tojson }};
        // Мы НЕ объявляем её снова с помощью const или let.

        document.getElementById('questionForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            // const questions = {{ questions | tojson }}; // <-- ЭТО НЕЛЬЗЯ! Уже объявлена через var.
            // Используем переменную 'questions' напрямую, как она была объявлена в HTML.

            const numQuestions = questions.length; // Используем существующую переменную 'questions'
            const answers = [];

            for (let i = 0; i < numQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="option${i}"]:checked`);
                if (selectedOption) {
                    answers.push(parseInt(selectedOption.value));
                } else {
                    // Если вопрос не отмечен, можно добавить null или обработать иначе
                    answers.push(null); // Или можно не отправлять тест, если есть неотвеченные
                }
            }

            // Проверим, все ли вопросы отвечены (опционально)
            if (answers.includes(null)) {
                 alert('Пожалуйста, ответьте на все вопросы.');
                 return;
            }

            fetch('/submit_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    questions: questions, // Передаём существующую переменную 'questions'
                    answers: answers
                })
            })
            .then(response => response.json())
            .then(data => {
                // Отображение результатов на той же странице
                displayResults(data);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при отправке теста.');
            });
        });

        function displayResults(data) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <h1>Результаты теста</h1>
                <p>Правильных ответов: ${data.correct_count} из ${data.total_count}</p>
                <p>Процент: ${data.score.toFixed(2)}%</p>
                <h2>Детализация:</h2>
                <div id="detailedResults">
                    ${data.detailed_results.map((res, index) => `
                        <div class="result-item ${res.is_correct ? 'correct' : 'incorrect'}">
                            <h4>${index + 1}. ${res.question}</h4>
                            <p>Ваш ответ: ${res.options[res.user_index]}</p>
                            <p>Правильный ответ: ${res.options[res.correct_index]}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    </script>
</body>
</html>